name: ğŸš€ Build & Deploy GoTalk Web

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  K8S_NAMESPACE: gotalk
  K8S_DEPLOYMENT: gotalk-web

jobs:
  # ============================================================
  # JOB 1: Build & Push Docker Image lÃªn Docker Hub
  # ============================================================
  build-and-push:
    name: ğŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.meta.outputs.version }}

    steps:
      - name: ğŸ“¢ ThÃ´ng bÃ¡o báº¯t Ä‘áº§u Build cho Discord
        run: |
          curl -H "Content-Type: application/json" -d '{"content": "â³ **[GoTalk Web]** Báº¯t Ä‘áº§u quÃ¡ trÃ¬nh Build & Push Docker Image tá»« commit: `'"${{ github.sha }}"'`"}' ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Generate image tag
        id: meta
        run: |
          DATE=$(date +'%y%m%d')
          TAG="v${DATE}.${{ github.run_number }}"
          echo "version=${TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Image tag: ${TAG}"

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build and Push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          target: runner
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/gotalk-web:${{ steps.meta.outputs.version }}
            ${{ secrets.DOCKERHUB_USERNAME }}/gotalk-web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # --- PHáº¦N Má»šI THÃŠM VÃ€O ---
      - name: âœ… ThÃ´ng bÃ¡o Build/Push Xong cho Discord
        if: success()
        run: |
          curl -H "Content-Type: application/json" -d '{"content": "ğŸ³ **[Build Xong]** ÄÃ£ build vÃ  push thÃ nh cÃ´ng image lÃªn Dockerhub\nğŸ‘‰ PhiÃªn báº£n hiá»‡n táº¡i: `'"${{ secrets.DOCKERHUB_USERNAME }}/gotalk-web:${{ steps.meta.outputs.version }}"'`"}' ${{ secrets.DISCORD_WEBHOOK_URL }}
          
      - name: âŒ ThÃ´ng bÃ¡o lá»—i Build (Náº¿u cÃ³)
        if: failure()
        run: |
          curl -H "Content-Type: application/json" -d '{"content": "ğŸš¨ **[Cáº£nh BÃ¡o Lá»—i]** QuÃ¡ trÃ¬nh Build & Push Image bá»‹ tháº¥t báº¡i. Anh em vÃ o Github CI check láº¡i code nha!"}' ${{ secrets.DISCORD_WEBHOOK_URL }}

  # ============================================================
  # JOB 2: Deploy lÃªn VPS qua SSH (kubectl set image)
  # ============================================================
  deploy:
    name: ğŸš€ Deploy to VPS (Kubernetes)
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: ğŸ“¢ BÃ¡o hiá»‡u Deploy lÃªn VPS
        run: |
          curl -H "Content-Type: application/json" -d '{"content": "ğŸš€ **[Tiáº¿n HÃ nh Deploy]** Äang tiáº¿n hÃ nh cáº­p nháº­t Image má»›i lÃªn mÃ¡y chá»§ VPS..."}' ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: ğŸ’» SSH into VPS and deploy
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          envs: IMAGE_TAG,DOCKERHUB_USERNAME,K8S_NAMESPACE,K8S_DEPLOYMENT
          script: |
            set -e

            NEW_IMAGE="${DOCKERHUB_USERNAME}/gotalk-web:${IMAGE_TAG}"

            echo "ğŸš€ Deploying: ${NEW_IMAGE}"
            echo "ğŸ“¦ Namespace: ${K8S_NAMESPACE} | Deployment: ${K8S_DEPLOYMENT}"

            kubectl set image deployment/${K8S_DEPLOYMENT} \
              web=${NEW_IMAGE} \
              --namespace=${K8S_NAMESPACE}

            echo "â³ Waiting for rollout to complete..."
            # Náº¿u web cÃ³ cháº­m thÃ¬ chá» tá»‘i Ä‘a lÃ  5 phÃºt thay vÃ¬ 3 phÃºt
            kubectl rollout status deployment/${K8S_DEPLOYMENT} \
              --namespace=${K8S_NAMESPACE} \
              --timeout=300s

            echo "âœ… Deployment successful!"
            echo "ğŸ“‹ Current pods:"
            kubectl get pods --namespace=${K8S_NAMESPACE} -l app=${K8S_DEPLOYMENT}
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          K8S_NAMESPACE: ${{ env.K8S_NAMESPACE }}
          K8S_DEPLOYMENT: ${{ env.K8S_DEPLOYMENT }}

      # --- PHáº¦N Má»šI THÃŠM VÃ€O ---
      - name: ğŸ‰ BÃ¡o cÃ¡o Deploy ThÃ nh CÃ´ng
        if: success()
        run: |
          curl -H "Content-Type: application/json" -d '{"content": "ğŸ‰ **[ThÃ nh CÃ´ng]** Há»‡ thá»‘ng Deploy thÃ nh cÃ´ng! Frontend (`'"${{ needs.build-and-push.outputs.image_tag }}"'`) Ä‘Ã£ Ä‘Æ°á»£c lÃ m má»›i trÃªn K3s."}' ${{ secrets.DISCORD_WEBHOOK_URL }}
          
      - name: âŒ BÃ¡o cÃ¡o Káº¹t VPS / GÃ£y Deploy
        if: failure()
        run: |
          curl -H "Content-Type: application/json" -d '{"content": "ğŸ”¥ **[CHÃY SERVER]** MÃ¡y chá»§ VPS khÃ´ng thá»ƒ thiáº¿t láº­p Image hoáº·c Web NextJS bá»‹ láº·p láº¡i lá»—i khá»Ÿi Ä‘á»™ng CrashLoopBackOff! Ká»¹ thuáº­t má»Ÿ K9s check liá»n!"}' ${{ secrets.DISCORD_WEBHOOK_URL }}
