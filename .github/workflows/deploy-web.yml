name: ğŸš€ Build & Deploy GoTalk Web

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  K8S_NAMESPACE: gotalk
  K8S_DEPLOYMENT: gotalk-web

jobs:
  # ============================================================
  # JOB 1: Build & Push Docker Image lÃªn Docker Hub
  # ============================================================
  build-and-push:
    name: ğŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest

    outputs:
      # Chá»‰ output image_tag (chuá»—i thuáº§n, khÃ´ng chá»©a secret)
      # VD: v260220.5
      image_tag: ${{ steps.meta.outputs.version }}

    steps:
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4

      # Táº¡o image tag theo format: v{YYMMDD}.{run_number}
      - name: ğŸ·ï¸ Generate image tag
        id: meta
        run: |
          DATE=$(date +'%y%m%d')
          TAG="v${DATE}.${{ github.run_number }}"
          echo "version=${TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Image tag: ${TAG}"

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build and Push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          target: runner
          push: true
          # DÃ¹ng trá»±c tiáº¿p secret á»Ÿ Ä‘Ã¢y (trong cÃ¹ng job) â†’ KHÃ”NG bá»‹ mask
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/gotalk-web:${{ steps.meta.outputs.version }}
            ${{ secrets.DOCKERHUB_USERNAME }}/gotalk-web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: âœ… Image pushed successfully
        run: |
          echo "ğŸ‰ Image pushed: ${{ secrets.DOCKERHUB_USERNAME }}/gotalk-web:${{ steps.meta.outputs.version }}"

  # ============================================================
  # JOB 2: Deploy lÃªn VPS qua SSH (kubectl set image)
  # ============================================================
  deploy:
    name: ğŸš€ Deploy to VPS (Kubernetes)
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: ğŸ’» SSH into VPS and deploy
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          # Truyá»n biáº¿n vÃ o SSH session qua envs thay vÃ¬ ná»™i suy trong script
          # â†’ trÃ¡nh bá»‹ GitHub mask do chá»©a secret value
          envs: IMAGE_TAG,DOCKERHUB_USERNAME,K8S_NAMESPACE,K8S_DEPLOYMENT
          script: |
            set -e

            # GhÃ©p image name tá»« envs Ä‘Æ°á»£c truyá»n vÃ o SSH session
            NEW_IMAGE="${DOCKERHUB_USERNAME}/gotalk-web:${IMAGE_TAG}"

            echo "ğŸš€ Deploying: ${NEW_IMAGE}"
            echo "ğŸ“¦ Namespace: ${K8S_NAMESPACE} | Deployment: ${K8S_DEPLOYMENT}"

            kubectl set image deployment/${K8S_DEPLOYMENT} \
              web=${NEW_IMAGE} \
              --namespace=${K8S_NAMESPACE}

            echo "â³ Waiting for rollout to complete..."
            kubectl rollout status deployment/${K8S_DEPLOYMENT} \
              --namespace=${K8S_NAMESPACE} \
              --timeout=180s

            echo "âœ… Deployment successful!"
            echo "ğŸ“‹ Current pods:"
            kubectl get pods --namespace=${K8S_NAMESPACE} -l app=${K8S_DEPLOYMENT}
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          K8S_NAMESPACE: ${{ env.K8S_NAMESPACE }}
          K8S_DEPLOYMENT: ${{ env.K8S_DEPLOYMENT }}

      - name: ğŸ‰ Deploy completed
        run: |
          echo "âœ… GoTalk Web deployed!"
          echo "ğŸ–¼ï¸ Image tag: ${{ needs.build-and-push.outputs.image_tag }}"
